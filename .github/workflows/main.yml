name: Compilazione LaTeX e pubblicazione su GitHub Pages
on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: texlive/texlive:latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Compila verbali interni
        run: |
          mkdir -p output/verbali_interni
          for file in Verbali/Interni/Latex/*.tex; do
            if [ -f "$file" ]; then
              echo "Compilo $file..."
              filename=$(basename "$file" .tex)
              basedir=$(dirname "$file")
              outdir=$(pwd)/output/verbali_interni
              
              cd "$basedir"
              latexmk -pdf -interaction=nonstopmode -file-line-error \
                -output-directory="$outdir" \
                -jobname="$filename" \
                "$(basename $file)" || true
              cd - > /dev/null
            fi
          done
      
      - name: Compila verbali esterni
        run: |
          mkdir -p output/verbali_esterni
          for file in Verbali/Esterni/Latex/*.tex; do
            if [ -f "$file" ]; then
              echo "Compilo $file..."
              filename=$(basename "$file" .tex)
              basedir=$(dirname "$file")
              outdir=$(pwd)/output/verbali_esterni
              
              cd "$basedir"
              latexmk -pdf -interaction=nonstopmode -file-line-error \
                -output-directory="$outdir" \
                -jobname="$filename" \
                "$(basename $file)" || true
              cd - > /dev/null
            fi
          done
      
      - name: Verifica PDFs generati
        run: |
          echo "=== PDFs Verbali Interni ==="
          ls -lh output/verbali_interni/*.pdf 2>/dev/null || echo "Nessun PDF interno trovato"
          echo "=== PDFs Verbali Esterni ==="
          ls -lh output/verbali_esterni/*.pdf 2>/dev/null || echo "Nessun PDF esterno trovato"
      
      - name: Carica PDFs come artifacts
        uses: actions/upload-artifact@v4
        with:
          name: pdfs-generati
          path: output/**/*.pdf
          if-no-files-found: warn
      
      - name: Crea pagina HTML
        run: |
          mkdir -p output
          cat > output/index.html << 'EOF'
          <!DOCTYPE html><html><head><meta charset='UTF-8'><title>Verbali</title>
          <style>
            body { 
              font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
              padding: 2em;
              max-width: 1200px;
              margin: 0 auto;
              background: #f5f5f5;
            }
            h1 { 
              margin-top: 1em;
              color: #333;
              border-bottom: 3px solid #0066cc;
              padding-bottom: 0.5em;
            }
            ul { 
              list-style: none;
              padding-left: 0;
              background: white;
              border-radius: 8px;
              padding: 1em;
              box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            }
            li { 
              margin-bottom: 0.5em;
              padding: 0.5em;
              border-bottom: 1px solid #eee;
            }
            li:last-child {
              border-bottom: none;
            }
            a {
              color: #0066cc;
              text-decoration: none;
              font-weight: 500;
            }
            a:hover {
              text-decoration: underline;
            }
          </style></head><body>
          EOF
          
          # Verbali Interni
          echo "<h1>ðŸ“‹ Verbali Interni</h1><ul>" >> output/index.html
          if ls output/verbali_interni/*.pdf 1> /dev/null 2>&1; then
            for f in $(ls -1 output/verbali_interni/*.pdf | sort -r); do
              name=$(basename "$f")
              echo "<li><a href='verbali_interni/$name'>$name</a></li>" >> output/index.html
            done
          else
            echo "<li>Nessun verbale interno disponibile</li>" >> output/index.html
          fi
          echo "</ul>" >> output/index.html
          
          # Verbali Esterni
          echo "<h1>ðŸ“„ Verbali Esterni</h1><ul>" >> output/index.html
          if ls output/verbali_esterni/*.pdf 1> /dev/null 2>&1; then
            for f in $(ls -1 output/verbali_esterni/*.pdf | sort -r); do
              name=$(basename "$f")
              echo "<li><a href='verbali_esterni/$name'>$name</a></li>" >> output/index.html
            done
          else
            echo "<li>Nessun verbale esterno disponibile</li>" >> output/index.html
          fi
          echo "</ul></body></html>" >> output/index.html
      
      - name: Pubblica su GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./output
